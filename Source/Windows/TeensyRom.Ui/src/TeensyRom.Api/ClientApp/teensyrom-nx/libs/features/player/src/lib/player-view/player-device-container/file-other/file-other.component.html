<lib-scaling-card
  [title]="title() || filename()"
  [subtitle]="releaseInfo()"
  [metadataSource]="metadataSource()"
>
  <!-- Corner content using slot -->
  @if (meta1() || meta2()) {
  <mat-chip-set slot="corner">
    @if (meta1()) {
    <mat-chip>{{ meta1() }}</mat-chip>
    } @if (meta2()) {
    <mat-chip>{{ meta2() }}</mat-chip>
    }
  </mat-chip-set>
  }

  <!-- Main content -->
  @if (hasFile()) {
    @if (hasContent()) {
      <!-- Description Section with conditional HSVC STIL title for songs -->
      @if (description()) {
        <div class="description-section">
          @if (isSong()) {
            <h4 class="section-title">HVSC STIL</h4>
          }
          <p class="description">{{ description() }}</p>
        </div>
      }

      <!-- NEW: Rating Display -->
      @if (avgRating()) {
        <div class="rating-section">
          <mat-icon>star</mat-icon>
          <span>{{ avgRating() | number:'1.1-1' }}/5.0</span>
          <span class="rating-count">({{ ratingCount() }} ratings)</span>
        </div>
      }

      <!-- Dynamic multi-column layout - each section gets its own column -->
      <div class="metadata-grid">
        <!-- Links Section -->
        @if (links().length > 0) {
          <div class="links-section">
            <h4>Links</h4>
            <div class="links-container">
              @for (link of links(); track $index) {
                <lib-external-link 
                  [href]="link.url"
                  [label]="link.name">
                </lib-external-link>
              }
            </div>
          </div>
        }

        <!-- YouTube Videos Section -->
        @if (youTubeVideos().length > 0) {
          <div class="youtube-section">
            <h4>Related Videos</h4>
            <div class="videos-container">
              @for (video of youTubeVideos(); track $index) {
                <lib-action-link 
                  [label]="video.channel"
                  icon="play_circle"
                  (linkClick)="openYouTubeDialog(video)">
                </lib-action-link>
              }
            </div>
          </div>
        }

        <!-- Competitions Section -->
        @if (competitions().length > 0) {
          <div class="competitions-section">
            <h4>Competition Results</h4>
            @for (comp of competitions(); track $index) {
              <div class="competition-item">
                <strong>{{ comp.name }}</strong>
                @if (comp.place) {
                  <span class="position">- Place {{ comp.place }}</span>
                }
              </div>
            }
          </div>
        }

        <!-- Tags Section -->
        @if (tags().length > 0) {
          <div class="tags-section">
            <h4>Tags</h4>
            <mat-chip-set>
              @for (tag of tags(); track $index) {
                <mat-chip [class]="'tag-' + tag.type">{{ tag.name }}</mat-chip>
              }
            </mat-chip-set>
          </div>
        }
      </div>

    } @else {
      <p class="no-metadata">Try launching a file from the device.</p>
    }
  } @else {
    <lib-empty-state-message
      icon="description"
      title="No File Launched"
      message="Launch a file from the file browser below."
      secondaryMessage="Try clicking the dice button to launch a random file."
      size="medium">
    </lib-empty-state-message>
  }
</lib-scaling-card>
