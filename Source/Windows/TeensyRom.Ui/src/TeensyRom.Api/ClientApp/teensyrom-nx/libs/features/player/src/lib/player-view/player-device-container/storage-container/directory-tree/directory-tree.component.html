<div class="directory-tree">
  <mat-card class="stretch-card">
    <mat-card-header>
      <mat-card-title>Directories</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <mat-tree
        #tree
        [dataSource]="directoryTree()"
        [childrenAccessor]="childrenAccessor"
        [trackBy]="trackByFn"
        [expansionKey]="expansionKeyFn"
      >
        <!-- Placeholder nodes -->
        <mat-tree-node *matTreeNodeDef="let node; when: isPlaceholder" matTreeNodePadding>
          <button mat-icon-button disabled>
            <mat-icon>{{ node.icon }}</mat-icon>
          </button>
          <span class="placeholder-text">{{ node.name }}</span>
        </mat-tree-node>

        <!-- Regular leaf nodes -->
        <mat-tree-node
          *matTreeNodeDef="let node"
          matTreeNodePadding
          tabindex="0"
          role="treeitem"
          [attr.aria-label]="node.name"
          [attr.aria-pressed]="isNodeSelected(node)"
          (click)="onDirectoryClick(node)"
          (keydown)="onNodeKeyDown($event, node)"
        >
          <button mat-icon-button disabled style="visibility: hidden">
            <mat-icon>chevron_right</mat-icon>
          </button>
          <lib-directory-tree-node
            [icon]="node.icon"
            [text]="node.name"
            [cssClass]="getNodeClasses(node)"
            [isSelected]="isNodeSelected(node)"
            [nodeType]="node.type"
          ></lib-directory-tree-node>
          @if (node.isLoading) {
          <mat-icon class="loading-icon">hourglass_empty</mat-icon>
          } @if (node.error) {
          <mat-icon class="error-icon" color="warn">error</mat-icon>
          }
        </mat-tree-node>
        <mat-tree-node
          *matTreeNodeDef="let node; when: hasChild"
          matTreeNodePadding
          matTreeNodeToggle
          [cdkTreeNodeTypeaheadLabel]="node.name"
          tabindex="0"
          role="treeitem"
          [attr.aria-label]="node.name"
          [attr.aria-pressed]="isNodeSelected(node)"
          (click)="onDirectoryClick(node)"
          (keydown)="onNodeKeyDown($event, node)"
        >
          <button
            mat-icon-button
            matTreeNodeToggle
            [attr.aria-label]="'Toggle ' + node.name"
            (click)="onToggleClick(node)"
          >
            <mat-icon class="mat-icon-rtl-mirror">
              {{ tree.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
            </mat-icon>
          </button>
          <lib-directory-tree-node
            [icon]="node.icon"
            [text]="node.name"
            [cssClass]="getNodeClasses(node)"
            [isSelected]="isNodeSelected(node)"
            [nodeType]="node.type"
          ></lib-directory-tree-node>
          @if (node.isLoading) {
          <mat-icon class="loading-icon">hourglass_empty</mat-icon>
          } @if (node.error) {
          <mat-icon class="error-icon" color="warn">error</mat-icon>
          }
        </mat-tree-node>
      </mat-tree>

      <!-- Debug JSON hidden for now -->
      <!-- <details class="debug-section">
        <summary>Debug: StorageStore Data</summary>
        <pre class="json-debug">{{ directories() | json }}</pre>
      </details> -->
    </mat-card-content>
  </mat-card>
</div>
